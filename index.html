<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>靈韻美學 - 讓靈魂聞見美，讓信仰成為感官的祝福</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /**************************************************/
      /***** 1. 產品資料庫：請在這裡管理您的產品 *****/
      /**************************************************/
      const products = [
        // 【重要】請務必將下面的 image 路徑，換成您在 images 資料夾中真實的圖片檔名
        {
          id: 'prod001',
          name: '乳香靜思者香氛',
          image: 'images/prod001.jpg', // 範例路徑，請替換
          description: '專為需要深度靜思與祈禱的靈性探索者設計。溫暖、神聖的氣息，幫助你進入安靜的內在空間，與神相遇。',
          specs: '容量: 100ml | 成分: 天然精油、酒精',
          price: 1200,
        },
        {
          id: 'prod002',
          name: '玫瑰關懷者香氛',
          image: 'images/prod002.jpg', // 範例路徑，請替換
          description: '溫柔的玫瑰香氣，象徵神的愛與關懷。適合在需要安慰與療癒的時刻使用，感受被溫柔擁抱的平靜。',
          specs: '容量: 100ml | 成分: 天然精油、酒精',
          price: 1200,
        },
        {
          id: 'prod003',
          name: '柑橘創造者香氛',
          image: 'images/prod003.jpg', // 範例路徑，請替換
          description: '充滿活力的柑橘調，激發創造力與喜樂。在靈性創作或迎接新的一天時使用，帶來陽光般的能量。',
          specs: '容量: 100ml | 成分: 天然精油、酒精',
          price: 1100,
        },
        {
          id: 'prod004',
          name: '靈性入門包',
          image: 'images/prod004.jpg', // 範例路徑，請替換
          description: '包含三款經典香氛小樣、靈修筆記本與經文卡。是開始您的靈性美學旅程的最佳選擇。',
          specs: '內容: 香氛 10ml x3, 筆記本 x1, 經文卡 x5',
          price: 2800,
        },
      ];

      /**************************************************/
      /***** 2. 系統設定 *****/
      /**************************************************/
      const TAX_RATE = 0.05;
      const QR_CODE_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='; // 請記得換成您自己的 QR Code Base64
      let cart = [];

      /**************************************************/
      /***** 3. 核心功能函式 (無需修改) *****/
      /**************************************************/

      // 渲染產品
      const productListContainer = document.getElementById('product-list');
      function renderProducts() {
        productListContainer.innerHTML = '';
        products.forEach(product => {
          const productHTML = `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col transition duration-300 card-hover">
              <div class="h-64 overflow-hidden">
                <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">
              </div>
              <div class="p-6 flex flex-col flex-grow">
                <h3 class="font-serif text-xl font-bold mb-2">${product.name}</h3>
                <p class="text-gray-500 text-sm mb-1">編號: ${product.id}</p>
                <p class="text-gray-500 text-sm mb-3">規格: ${product.specs}</p>
                <p class="text-gray-600 mb-4 flex-grow">${product.description}</p>
                <div class="flex justify-between items-center mt-auto pt-4 border-t">
                  <span class="text-gold font-bold text-lg">NT$ ${product.price.toLocaleString()}</span>
                  <button onclick="addToCart('${product.id}')" class="bg-gold hover:bg-gold/90 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300">
                    選購
                  </button>
                </div>
              </div>
            </div>`;
          productListContainer.innerHTML += productHTML;
        });
      }

      // 加入購物車
      window.addToCart = (productId) => {
        const item = cart.find(i => i.id === productId);
        if (item) item.quantity++; else cart.push({ id: productId, quantity: 1 });
        updateCart();
        showNotification(`${products.find(p => p.id === productId).name} 已加入訂單！`);
      }

      // 提示訊息
      function showNotification(message) {
        const el = document.createElement('div');
        el.className = 'fixed top-24 right-5 bg-olive text-white px-6 py-3 rounded-lg shadow-lg transition-transform transform translate-x-full';
        el.innerText = message;
        document.body.appendChild(el);
        setTimeout(() => el.style.transform = 'translateX(0)', 10);
        setTimeout(() => {
          el.style.transform = 'translateX(calc(100% + 20px))';
          setTimeout(() => el.remove(), 300);
        }, 3000);
      }

      // 更新購物車
      function updateCart() {
        const container = document.getElementById('cart-items-container');
        container.innerHTML = '';
        let subtotal = 0;
        if (cart.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-500">您的訂單是空的。</p>';
          document.getElementById('to-checkout-button').disabled = true;
        } else {
          document.getElementById('to-checkout-button').disabled = false;
          cart.forEach(item => {
            const product = products.find(p => p.id === item.id);
            const itemTotal = product.price * item.quantity;
            subtotal += itemTotal;
            container.innerHTML += `
              <div class="flex items-center gap-4 border-b pb-4">
                <img src="${product.image}" alt="${product.name}" class="w-16 h-16 object-cover rounded-md">
                <div class="flex-grow">
                  <p class="font-bold">${product.name}</p>
                  <p class="text-sm text-gray-500">NT$ ${product.price.toLocaleString()}</p>
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="updateQuantity('${item.id}', -1)" class="w-7 h-7 bg-gray-200 rounded-full font-bold">-</button>
                  <span>${item.quantity}</span>
                  <button onclick="updateQuantity('${item.id}', 1)" class="w-7 h-7 bg-gray-200 rounded-full font-bold">+</button>
                </div>
                <p class="w-24 text-right font-medium">NT$ ${itemTotal.toLocaleString()}</p>
                <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700">&times;</button>
              </div>`;
          });
        }
        const tax = subtotal * TAX_RATE;
        document.getElementById('subtotal').innerText = `NT$ ${Math.round(subtotal).toLocaleString()}`;
        document.getElementById('tax').innerText = `NT$ ${Math.round(tax).toLocaleString()}`;
        document.getElementById('total').innerText = `NT$ ${Math.round(subtotal + tax).toLocaleString()}`;
        document.getElementById('cart-item-count').innerText = cart.reduce((sum, item) => sum + item.quantity, 0);
      }

      // 更新數量
      window.updateQuantity = (id, change) => {
        const item = cart.find(i => i.id === id);
        if (item) {
          item.quantity += change;
          if (item.quantity <= 0) removeFromCart(id); else updateCart();
        }
      }

      // 移除商品
      window.removeFromCart = (id) => {
        cart = cart.filter(i => i.id !== id);
        updateCart();
      }

      // ===============================================
      // ===== 最終版 PDF 產生函式 =====
      // ===============================================
      async function generateOrderPDF(customerData, orderNumber) {
        const submitButton = document.querySelector('#customer-form button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerText = '訂單產生中...';

        const { jsPDF } = window.jspdf;
        const pdfContent = document.getElementById('pdf-content');
        
        let itemsHTML = '';
        let subtotal = cart.reduce((sum, item) => {
            const product = products.find(p => p.id === item.id);
            itemsHTML += `<tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${product.name} (${product.id})</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">${item.quantity}</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">${product.price.toLocaleString()}</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">${(product.price * item.quantity).toLocaleString()}</td>
            </tr>`;
            return sum + product.price * item.quantity;
        }, 0);
        const tax = subtotal * TAX_RATE;
        const total = subtotal + tax;
        
        pdfContent.innerHTML = `
          <div style="font-family: sans-serif; padding: 20px; width: 700px; background: white;">
            <h1 style="font-size: 24px; color: #556B2F; border-bottom: 2px solid #D4AF37; padding-bottom: 10px;">靈韻美學 訂單資訊</h1>
            <p><strong>訂單編號:</strong> ${orderNumber}</p>
            <p><strong>訂購日期:</strong> ${new Date().toLocaleDateString('zh-TW')}</p>
            <h2 style="font-size: 18px; margin-top: 20px;">客戶資訊</h2>
            <p><strong>姓名:</strong> ${customerData.name}</p>
            <p><strong>電話:</strong> ${customerData.phone}</p>
            <p><strong>地址:</strong> ${customerData.address}</p>
            <h2 style="font-size: 18px; margin-top: 20px;">訂單明細</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <thead><tr>
                    <th style="text-align: left; padding: 8px; border-bottom: 2px solid #333;">品名</th>
                    <th style="text-align: right; padding: 8px; border-bottom: 2px solid #333;">數量</th>
                    <th style="text-align: right; padding: 8px; border-bottom: 2px solid #333;">單價</th>
                    <th style="text-align: right; padding: 8px; border-bottom: 2px solid #333;">小計</th>
                </tr></thead>
                <tbody>${itemsHTML}</tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <p><strong>小計:</strong> NT$ ${Math.round(subtotal).toLocaleString()}</p>
                <p><strong>營業稅 (5%):</strong> NT$ ${Math.round(tax).toLocaleString()}</p>
                <p style="font-size: 20px; font-weight: bold;"><strong>總計:</strong> NT$ ${Math.round(total).toLocaleString()}</p>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee;">
                <div style="padding: 15px; background-color: #f7f3e9; border-left: 4px solid #D4AF37; width: 70%;">
                    <h2 style="font-size: 18px;">匯款資訊 & 後續步驟</h2>
                    <p><strong>銀行：</strong> 元大銀行 南屯分行</p>
                    <p><strong>帳號：</strong> 00168266574918</p>
                    <p style="margin-top: 10px;">完成匯款後，請加入我們的官方帳號 (右側QR Code)，並告知您的「訂單編號」及「匯款帳號末四碼」。</p>
                </div>
                <img src="${QR_CODE_BASE64}" style="width: 100px; height: 100px;">
            </div>
          </div>`;
        
        try {
          const canvas = await html2canvas(pdfContent.firstElementChild, { scale: 2 });
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
          pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
          pdf.save(`lingyun-order-${orderNumber}.pdf`);

          document.getElementById('checkout-view').classList.add('hidden');
          document.getElementById('confirmation-view').classList.remove('hidden');
          cart = [];
          updateCart();
        } catch (error) {
          console.error("PDF 產生失敗:", error);
          alert(`抱歉，訂單 PDF 產生失敗，請聯繫我們。錯誤訊息: ${error.message}`);
        } finally {
          submitButton.disabled = false;
          submitButton.innerText = '確認訂單並產生訂單資訊';
        }
      }

      /**************************************************/
      /***** 4. 事件監聽與流程控制 (無需修改) *****/
      /**************************************************/
      const modal = document.getElementById('order-modal');
      const cartButton = document.getElementById('cart-button');
      const closeModalButton = document.getElementById('close-modal-button');
      const toCheckoutButton = document.getElementById('to-checkout-button');
      const backToCartButton = document.getElementById('back-to-cart-button');
      const customerForm = document.getElementById('customer-form');
      
      const cartView = document.getElementById('cart-view');
      const checkoutView = document.getElementById('checkout-view');
      const confirmationView = document.getElementById('confirmation-view');

      document.getElementById('qr-code-placeholder').src = QR_CODE_BASE64;

      const openModal = () => {
        updateCart();
        modal.classList.remove('opacity-0', 'pointer-events-none');
        modal.querySelector('.modal-container').classList.remove('scale-95');
      };
      const closeModal = () => {
        modal.classList.add('opacity-0', 'pointer-events-none');
        modal.querySelector('.modal-container').classList.add('scale-95');
        setTimeout(() => {
          cartView.classList.remove('hidden');
          checkoutView.classList.add('hidden');
          confirmationView.classList.add('hidden');
        }, 300);
      };

      cartButton.addEventListener('click', openModal);
      closeModalButton.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      toCheckoutButton.addEventListener('click', () => {
        cartView.classList.add('hidden');
        checkoutView.classList.remove('hidden');
      });
      backToCartButton.addEventListener('click', () => {
        checkoutView.classList.add('hidden');
        cartView.classList.remove('hidden');
      });

      customerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const customerData = Object.fromEntries(new FormData(customerForm).entries());
        const orderNumber = `LY${new Date().getTime()}`;
        await generateOrderPDF(customerData, orderNumber);
      });

      renderProducts();
    });
  </script>
</body>
</html>